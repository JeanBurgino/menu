<?php
/**
 * Debug Script f√ºr Bring! API
 * 
 * Testet die Konfiguration und API-Verbindung
 * Optimierte Version mit besserer Ausgabe
 */

// Error Reporting
error_reporting(E_ALL);
ini_set('display_errors', 1);

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n";
echo "‚ïë       Bring! API Debug & Diagnose v2.0           ‚ïë\n";
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n";

$errors = [];
$warnings = [];

// ==================== 1. KONFIGURATION PR√úFEN ====================

echo "üìã 1. Pr√ºfe Konfigurationsdateien...\n";
echo str_repeat("‚îÄ", 50) . "\n";

// config.php
if (file_exists('config.php')) {
    echo "   ‚úÖ config.php gefunden\n";
    require_once 'config.php';
} else {
    echo "   ‚ùå config.php nicht gefunden!\n";
    $errors[] = "config.php fehlt";
}

// bring-config.php
if (file_exists('bring-config.php')) {
    echo "   ‚úÖ bring-config.php gefunden\n";
    require_once 'bring-config.php';
} else {
    echo "   ‚ùå bring-config.php nicht gefunden!\n";
    $errors[] = "bring-config.php fehlt";
}

echo "\n";

// ==================== 2. KONSTANTEN PR√úFEN ====================

echo "‚öôÔ∏è  2. Pr√ºfe Konfigurationswerte...\n";
echo str_repeat("‚îÄ", 50) . "\n";

$config_checks = [
    'BRING_EMAIL' => 'Bring! E-Mail',
    'BRING_PASSWORD' => 'Bring! Passwort',
    'BRING_LIST_NAME' => 'Listen-Name',
    'BRING_USE_API' => 'API-Modus'
];

foreach ($config_checks as $const => $label) {
    if (defined($const)) {
        $value = constant($const);
        if ($const === 'BRING_PASSWORD' && !empty($value)) {
            $masked = str_repeat('*', min(strlen($value), 8));
            echo "   ‚úÖ {$label}: {$masked}\n";
        } elseif ($const === 'BRING_EMAIL' && !empty($value)) {
            $parts = explode('@', $value);
            $masked = substr($parts[0], 0, 3) . '***@' . $parts[1];
            echo "   ‚úÖ {$label}: {$masked}\n";
        } elseif ($const === 'BRING_USE_API') {
            $status = $value ? 'aktiviert' : 'deaktiviert';
            echo "   ‚úÖ {$label}: {$status}\n";
        } else {
            echo "   ‚úÖ {$label}: " . ($value ?: 'LEER') . "\n";
        }
        
        if (empty($value) && $const !== 'BRING_USE_API') {
            $warnings[] = "{$label} ist leer";
        }
    } else {
        echo "   ‚ùå {$label}: nicht definiert\n";
        $errors[] = "{$const} ist nicht definiert";
    }
}

echo "\n";

// ==================== 3. PHP EXTENSIONS PR√úFEN ====================

echo "üîß 3. Pr√ºfe PHP Extensions...\n";
echo str_repeat("‚îÄ", 50) . "\n";

$required_extensions = [
    'curl' => 'cURL (f√ºr HTTP Requests)',
    'json' => 'JSON (f√ºr Datenverarbeitung)',
    'pdo' => 'PDO (f√ºr Datenbank)',
    'pdo_mysql' => 'PDO MySQL (f√ºr MySQL)'
];

foreach ($required_extensions as $ext => $description) {
    if (extension_loaded($ext)) {
        echo "   ‚úÖ {$description}\n";
    } else {
        echo "   ‚ùå {$description} fehlt!\n";
        $errors[] = "PHP Extension '{$ext}' fehlt";
    }
}

echo "\n";

// ==================== 4. DATEIEN PR√úFEN ====================

echo "üìÅ 4. Pr√ºfe erforderliche Dateien...\n";
echo str_repeat("‚îÄ", 50) . "\n";

$required_files = [
    'classes/BringAPI.php' => 'Bring! API Klasse',
    'classes/Database.php' => 'Datenbank Klasse',
    'api.php' => 'API Endpoint'
];

foreach ($required_files as $file => $description) {
    if (file_exists($file)) {
        echo "   ‚úÖ {$description}: {$file}\n";
        
        // Syntax-Check
        $output = [];
        $return = 0;
        exec("php -l {$file} 2>&1", $output, $return);
        if ($return !== 0) {
            echo "      ‚ö†Ô∏è  Syntax-Fehler gefunden!\n";
            $warnings[] = "Syntax-Fehler in {$file}";
        }
    } else {
        echo "   ‚ùå {$description}: {$file} fehlt!\n";
        $errors[] = "{$file} fehlt";
    }
}

echo "\n";

// ==================== 5. VERZEICHNISSE PR√úFEN ====================

echo "üìÇ 5. Pr√ºfe Verzeichnisse...\n";
echo str_repeat("‚îÄ", 50) . "\n";

$required_dirs = [
    'exports/bring' => 'Bring! Exports',
    'logs' => 'Log-Dateien',
    'classes' => 'PHP Klassen'
];

foreach ($required_dirs as $dir => $description) {
    if (is_dir($dir)) {
        echo "   ‚úÖ {$description}: /{$dir}\n";
        
        // Schreibrechte pr√ºfen
        if (is_writable($dir)) {
            echo "      ‚úÖ Schreibrechte OK\n";
        } else {
            echo "      ‚ö†Ô∏è  Keine Schreibrechte!\n";
            $warnings[] = "Keine Schreibrechte f√ºr {$dir}";
        }
    } else {
        echo "   ‚ö†Ô∏è  {$description}: /{$dir} fehlt\n";
        echo "      üí° Erstelle mit: mkdir -p {$dir}\n";
        $warnings[] = "{$dir} fehlt";
    }
}

echo "\n";

// ==================== 6. BRING! API TEST ====================

if (defined('BRING_USE_API') && BRING_USE_API && 
    defined('BRING_EMAIL') && !empty(BRING_EMAIL) && 
    defined('BRING_PASSWORD') && !empty(BRING_PASSWORD)) {
    
    echo "üîå 6. Teste Bring! API Verbindung...\n";
    echo str_repeat("‚îÄ", 50) . "\n";
    
    if (!file_exists('classes/BringAPI.php')) {
        echo "   ‚ùå BringAPI.php fehlt!\n\n";
    } else {
        require_once 'classes/BringAPI.php';
        
        try {
            $bring = new BringAPI(BRING_EMAIL, BRING_PASSWORD);
            
            echo "   ‚Üí Sende Login-Request...\n";
            $loginResult = $bring->login();
            
            if ($loginResult) {
                echo "   ‚úÖ Login erfolgreich!\n\n";
                
                $userInfo = $bring->getUserInfo();
                echo "   üë§ Benutzer-Info:\n";
                echo "      Name: {$userInfo['name']}\n";
                echo "      UUID: {$userInfo['uuid']}\n\n";
                
                echo "   ‚Üí Lade Listen...\n";
                $lists = $bring->getLists();
                
                if (isset($lists['lists'])) {
                    echo "   ‚úÖ Listen erfolgreich geladen!\n\n";
                    echo "   üìã Verf√ºgbare Listen:\n";
                    
                    $found = false;
                    foreach ($lists['lists'] as $list) {
                        $marker = ($list['name'] === BRING_LIST_NAME) ? ' ‚≠ê KONFIGURIERT' : '';
                        echo "      ‚Ä¢ {$list['name']}{$marker}\n";
                        echo "        UUID: {$list['listUuid']}\n";
                        
                        if ($list['name'] === BRING_LIST_NAME) {
                            $found = true;
                        }
                    }
                    
                    echo "\n";
                    
                    if (!$found) {
                        echo "   ‚ö†Ô∏è  Konfigurierte Liste '" . BRING_LIST_NAME . "' nicht gefunden!\n";
                        echo "      üí° Bitte BRING_LIST_NAME in bring-config.php anpassen\n\n";
                        $warnings[] = "Konfigurierte Liste nicht gefunden";
                    } else {
                        echo "   ‚úÖ Konfigurierte Liste gefunden und einsatzbereit!\n\n";
                    }
                } else {
                    echo "   ‚ö†Ô∏è  Keine Listen gefunden\n\n";
                    $warnings[] = "Keine Listen in Bring! Account";
                }
                
                // Test-Export (optional)
                echo "   üß™ M√∂chtest du einen Test-Artikel hinzuf√ºgen? (y/n): ";
                $handle = fopen("php://stdin", "r");
                $line = fgets($handle);
                if (trim($line) === 'y') {
                    $list = $bring->getListByName(BRING_LIST_NAME);
                    if ($list) {
                        $result = $bring->saveItem($list['listUuid'], 'Test-Artikel (Debug)', 'von Debug-Script');
                        if ($result['success']) {
                            echo "   ‚úÖ Test-Artikel erfolgreich hinzugef√ºgt!\n";
                        } else {
                            echo "   ‚ùå Fehler beim Hinzuf√ºgen: " . ($result['error'] ?? 'Unknown') . "\n";
                        }
                    }
                }
                echo "\n";
                
            } else {
                echo "   ‚ùå Login fehlgeschlagen!\n";
                echo "      üí° Pr√ºfe Email und Passwort in bring-config.php\n\n";
                $errors[] = "Bring! Login fehlgeschlagen";
            }
        } catch (Exception $e) {
            echo "   ‚ùå Fehler: " . $e->getMessage() . "\n\n";
            $errors[] = "Bring! API Fehler: " . $e->getMessage();
        }
    }
} else {
    echo "‚è≠Ô∏è  6. Bring! API Test √ºbersprungen\n";
    echo str_repeat("‚îÄ", 50) . "\n";
    echo "   API-Modus ist deaktiviert oder Login-Daten fehlen\n";
    echo "   ‚Üí Deeplink-Methode wird verwendet\n\n";
}

// ==================== 7. ZUSAMMENFASSUNG ====================

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n";
echo "‚ïë                  ZUSAMMENFASSUNG                  ‚ïë\n";
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n";

if (count($errors) === 0 && count($warnings) === 0) {
    echo "üéâ Alle Tests erfolgreich!\n";
    echo "‚úÖ Deine Bring! Integration ist einsatzbereit!\n\n";
} else {
    if (count($errors) > 0) {
        echo "‚ùå FEHLER (" . count($errors) . "):\n";
        foreach ($errors as $error) {
            echo "   ‚Ä¢ {$error}\n";
        }
        echo "\n";
    }
    
    if (count($warnings) > 0) {
        echo "‚ö†Ô∏è  WARNUNGEN (" . count($warnings) . "):\n";
        foreach ($warnings as $warning) {
            echo "   ‚Ä¢ {$warning}\n";
        }
        echo "\n";
    }
    
    if (count($errors) > 0) {
        echo "üîß Bitte behebe die Fehler bevor du fortf√§hrst.\n\n";
    } else {
        echo "‚ÑπÔ∏è  Die App funktioniert, aber einige Optimierungen sind empfohlen.\n\n";
    }
}

echo "üìö Mehr Infos: README.md\n";
echo "üí¨ Support: Pr√ºfe /logs/ f√ºr Details\n\n";

exit(count($errors) > 0 ? 1 : 0);
